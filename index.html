<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phone Preview Editor â€“ Live</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.47.0/tabler-icons.min.css">
  <style>
    :root{
      --bg:#0b0f14; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb; --accent:#60a5fa; --accent2:#34d399;
      --divider:#1f2937; --phone:#0f172a; --bezel:#0b1220; --shadow:0 20px 40px rgba(0,0,0,.35);
      --app-bg: linear-gradient(180deg,#0b0f14,#0a101a);
    }
    :root[data-theme='light']{
      --bg:#f7f8fa; --panel:#ffffff; --muted:#6b7280; --text:#111827; --accent:#2563eb; --accent2:#059669;
      --divider:#e5e7eb; --phone:#f3f4f6; --bezel:#e5e7eb; --shadow:0 12px 24px rgba(0,0,0,.12);
      --app-bg: linear-gradient(180deg,#f8fafc,#eef2f7);
    }
    /* Light mode overall contrast fixes (non-editor UI) */
    :root[data-theme='light'] .panel{ background:var(--panel); backdrop-filter:none; }
    :root[data-theme='light'] .tabs{ background:rgba(0,0,0,.04); }
    :root[data-theme='light'] .rightTop{ background:rgba(0,0,0,.04); }
    :root[data-theme='light'] .toggle{ color:#374151; }
    :root[data-theme='light'] .hint{ color:#374151; opacity:.75; }
    :root[data-theme='light'] .btn{ color:#111827; }
    :root[data-theme='light'] .tools label,
    :root[data-theme='light'] .rightTop label{ color:#374151; }
    /* Light mode: force top header text to black */
    :root[data-theme='light'] header,
    :root[data-theme='light'] header .title,
    :root[data-theme='light'] header .sub{ color:#000 !important; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--app-bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    /* Selection: Google-like blue transparent */
    ::selection{background:rgba(66,133,244,.35)}
    ::-moz-selection{background:rgba(66,133,244,.35)}
    /* Ace editor selection override */
    .ace_editor .ace_marker-layer .ace_selection{background:rgba(66,133,244,.35)}
    .app{display:grid;grid-template-columns: var(--left-col, 1fr) 8px var(--right-col, 1fr);grid-template-areas:"left divider right";gap:12px;height:100%;padding:12px}
    .divider{width:8px;cursor:col-resize;background:var(--divider);border-radius:10px}
    .app.dragging .divider{background:#334155}
    /* Swap layout (right | divider | left) */
    .app.swap{grid-template-areas:"right divider left"}
    header{grid-column:1/-1;display:flex;align-items:center;gap:10px;padding:8px 4px 4px}
    header .title{font-size:18px;font-weight:700;letter-spacing:.2px;}
    header .sub{color:var(--muted);font-size:12px}
    .panel{background:rgba(17,24,39,.72);backdrop-filter:blur(8px);border:1px solid var(--divider);border-radius:16px;overflow:auto;display:flex;flex-direction:column;min-height:0}
    #left{grid-area:left}
    #right{grid-area:right}
    #splitter{grid-area:divider}

    .tabs{display:flex;align-items:center;gap:6px;padding:8px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--divider)}
    .tab{padding:8px 10px;border-radius:10px;cursor:pointer;color:var(--muted);display:flex;align-items:center;gap:6px}
    .tab.active{background:rgba(96,165,250,.15);color:var(--text)}
    /* Light mode: clearer tab text and distinct active colors */
    :root[data-theme='light'] .tabs .tab{ color:#374151; }
    :root[data-theme='light'] .tabs .tab.active{ color:#000; }
    :root[data-theme='light'] .tabs .tab[data-target="html"].active{ background:#fde68a; /* amber-200 */ }
    :root[data-theme='light'] .tabs .tab[data-target="css"].active{  background:#bae6fd; /* sky-200 */ }
    :root[data-theme='light'] .tabs .tab[data-target="js"].active{   background:#c7d2fe; /* indigo-200 */ }
    /* Error badge + error state on tab */
    .tab .badge{min-width:16px;height:16px;padding:0 5px;border-radius:8px;background:#ef4444;color:#fff;font-size:10px;line-height:16px;text-align:center;display:none}
    .tab.error{color:#ef4444}
    .tab.error .badge{display:inline-block}
    /* VS Code-like squiggly underlines and gutter hints */
    .ace_editor .ace_error{ text-decoration: underline wavy #e11d48 1px; text-underline-offset: 1px; }
    .ace_editor .ace_warning{ text-decoration: underline wavy #f59e0b 1px; text-underline-offset: 1px; }
    .ace_gutter-cell.ace_error{ border-left:2px solid #e11d48; }
    .ace_gutter-cell.ace_warning{ border-left:2px solid #f59e0b; }
    /* (Custom token underline removed; using native squiggles only) */
    /* (Tooltip removed by request) */
    .tools{margin-left:auto;display:flex;align-items:center;gap:8px}
    .stopwatch{display:inline-flex;align-items:center;gap:6px;margin-left:6px}
    .stopwatch .sw-time{font-variant-numeric:tabular-nums;font-size:12px;color:var(--text);opacity:.9;min-width:44px;text-align:center}
    .stopwatch .btn.icon{padding:4px 6px}
    :root[data-theme='light'] .stopwatch .sw-time{color:#111827;opacity:1}
    
    .btn.icon{padding:6px 8px}
    .btn{background:var(--panel);border:1px solid var(--divider);padding:8px 10px;border-radius:10px;color:var(--text);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .toggle{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:var(--muted)}
    .editor{flex:1;min-height:0;overflow:auto}
    #editor-html,#editor-css,#editor-js{position:relative;width:100%;height:100%;display:none}
    #editor-html.active,#editor-css.active,#editor-js.active{display:block}

    .rightTop{display:flex;gap:8px;align-items:center;padding:8px 10px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--divider);position:sticky;top:0;z-index:5}
    .rightTop label{font-size:12px;color:var(--muted)}
    .rightTop select,.rightTop input[type="range"], .rightTop button{background:var(--panel);color:var(--text);border:1px solid var(--divider);border-radius:10px;padding:6px 8px}
    .phoneWrap{flex:1;display:flex;align-items:center;justify-content:center;padding:16px}
    /* Problems panel */
    .problems{border-top:1px solid var(--divider);background:rgba(0,0,0,.04);max-height:160px;overflow:auto;font-size:12px}
    .problems .item{display:flex;gap:8px;padding:8px 10px;border-bottom:1px solid var(--divider);align-items:flex-start;cursor:pointer}
    .problems .item:hover{background:rgba(255,255,255,.05)}
    .problems .ic{color:#ef4444}
    .problems .msg{flex:1;color:var(--text)}
    .problems .loc{color:var(--muted);font-variant-numeric:tabular-nums}
    :root[data-theme='light'] .problems{background:rgba(0,0,0,.03)}

    .phone{
      position:relative;display:flex;align-items:center;justify-content:center;
      background:var(--phone);box-shadow:var(--shadow);
      border: 12px solid var(--bezel);
      overflow:hidden;
      transform-origin:center center;
    }
    /* Device-specific sizes */
    .phone.device-phone{ width:360px;height:794px;border-radius:38px; }
    .phone.device-tablet{ width:600px;height:800px;border-radius:20px; }
    .notch{
      position:absolute;top:6px;left:50%;transform:translateX(-50%);
      width:160px;height:24px;background:#050a16;border-radius:0 0 16px 16px;opacity:.9;
      border:1px solid #0b1022;border-top:none
    }
    /* Tablets usually don't have a phone notch */
    .device-tablet .notch{ display:none; }
    .screen{position:absolute;inset:0;border-radius:26px;overflow:hidden;background:var(--panel)}
    .screen iframe{width:100%;height:100%;border:0;background:white;display:block;}
    .hint{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);font-size:10px;color:#cbd5e1;opacity:.7}

    /* Settings Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-backdrop.open{display:flex}
    .modal{background:var(--panel);border:1px solid var(--divider);border-radius:14px;width:min(440px, 92vw);box-shadow:var(--shadow);color:var(--text)}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--divider)}
    .modal header h3{margin:0;font-size:16px}
    .modal .content{padding:14px}
    .field{display:grid;grid-template-columns: 1fr auto;gap:10px;align-items:center;margin:8px 0}
    .field label{font-size:12px;color:var(--muted);grid-column:1/-1;margin-bottom:6px}
    .row{display:flex;gap:10px;align-items:center}
    .row input[type="range"]{flex:1}
    .row input[type="number"]{width:80px;background:var(--panel);border:1px solid var(--divider);border-radius:10px;color:var(--text);padding:6px 8px}
    .modal footer{display:flex;ju stify-content:flex-end;gap:8px;padding:12px 14px;border-top:1px solid var(--divider)}
    .modal .btn{background:var(--panel);border:1px solid var(--divider);padding:8px 12px;border-radius:10px;color:var(--text);cursor:pointer}
    .modal .btn.primary{background:#1d4ed8;border-color:#1e40af}
  </style>
</head>
<body>
  <div class="app">
    <!-- left panel -->
    <section class="panel" id="left">
      <div class="tabs">
        <div class="tab active" data-target="html"><i class="ti ti-code"></i> HTML</div>
        <div class="tab" data-target="css"><i class="ti ti-braces"></i> CSS</div>
        <div class="tab" data-target="js"><i class="ti ti-bolt"></i> JS</div>
        <div class="tools">
          <label class="toggle"><input type="checkbox" id="auto" checked> Auto-refresh</label>
          <span class="stopwatch" id="stopwatch">
            <button class="btn icon sw-toggle" id="swToggle" title="Start / Pause"><i class="ti ti-player-play"></i></button>
            <span class="sw-time" id="swTime">00:00</span>
            <button class="btn icon sw-reset" id="swReset" title="Reset"><i class="ti ti-refresh"></i></button>
          </span>
          <button class="btn icon" id="themeToggle" title="Toggle theme"><i class="ti ti-moon"></i></button>
          
          <button class="btn icon" id="swapPanels" title="Swap left/right"><i class="ti ti-arrows-left-right"></i></button>
          <button class="btn icon" id="settings" title="Settings"><i class="ti ti-settings"></i></button>
          <button class="btn" id="copy"><i class="ti ti-copy"></i> Copy</button>
          <button class="btn" id="download"><i class="ti ti-download"></i> Export ZIP</button>
          <button class="btn" id="problems"><i class="ti ti-alert-triangle"></i> Problems <span id="problemsCount" style="margin-left:6px;background:#ef4444;color:#fff;border-radius:10px;padding:0 6px;font-size:11px;display:none">0</span></button>
        </div>
      </div>
      <div class="editor">
        <div id="editor-html" class="active"></div>
        <div id="editor-css"></div>
        <div id="editor-js"></div>
      </div>
      <div id="problemsPanel" class="problems" style="display:none"></div>
    </section>
    <!-- right panel -->
    <div class="divider" id="splitter" role="separator" aria-orientation="vertical" aria-label="Resize panels"></div>
    <section class="panel" id="right">
      <div class="rightTop">
        <label>Width</label>
        <input type="range" id="scaleW" min="0.5" max="1.5" step="0.01" value="1" />
        <label>Height</label>
        <input type="range" id="scaleH" min="0.5" max="1.5" step="0.01" value="1" />
        <button id="rotate" title="Rotate"><i class="ti ti-rotate-clockwise"></i></button>
      </div>
      <div class="phoneWrap">
        <div class="phone" id="phone">
          <div class="notch"></div>
          <div class="screen"><iframe id="preview" scrolling="auto"></iframe></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Settings Modal -->
  <div class="modal-backdrop" id="settingsModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
      <header>
        <h3 id="dlgTitle"><i class="ti ti-settings"></i> Settings</h3>
        <button class="btn icon" id="dlgClose" title="Close"><i class="ti ti-x"></i></button>
      </header>
      <div class="content">
        <div class="field">
          <label for="dlgRadius">Phone corner radius</label>
          <div class="row">
            <input type="range" id="dlgRadius" min="0" max="80" step="1" />
            <input type="number" id="dlgRadiusNum" min="0" max="80" step="1" />
          </div>
        </div>
        <div class="field">
          <label for="dlgDevice">Device type</label>
          <div class="row">
            <select id="dlgDevice" style="flex:1;background:#0b1220;border:1px solid var(--divider);border-radius:10px;color:var(--text);padding:6px 8px">
              <option value="phone">Phone 6.9"</option>
              <option value="tablet">Tablet 10"</option>
            </select>
          </div>
        </div>
      </div>
      <footer>
        <button class="btn" id="dlgCancel">Cancel</button>
        <button class="btn primary" id="dlgSave">Save</button>
      </footer>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.36.2/src-min-noconflict/ace.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.36.2/src-min-noconflict/ext-language_tools.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <script>
    // Ensure Ace can load workers from CDN for live syntax checking
    ace.config.set('basePath','https://cdn.jsdelivr.net/npm/ace-builds@1.36.2/src-min-noconflict');
    const htmlEditor = ace.edit("editor-html", { theme: "ace/theme/one_dark", mode: "ace/mode/html", fontSize: 14, showPrintMargin:false, wrap:true, useWorker:true, enableBasicAutocompletion:true, enableLiveAutocompletion:true});
    const cssEditor  = ace.edit("editor-css",  { theme: "ace/theme/one_dark", mode: "ace/mode/css",  fontSize: 14, showPrintMargin:false, wrap:true, useWorker:true, enableBasicAutocompletion:true, enableLiveAutocompletion:true});
    const jsEditor   = ace.edit("editor-js",   { theme: "ace/theme/one_dark", mode: "ace/mode/javascript", fontSize: 14, showPrintMargin:false, wrap:true, useWorker:true, enableBasicAutocompletion:true, enableLiveAutocompletion:true});

    const starterHTML = `<!doctype html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/><title>My Android HTML App</title><style>body{margin:0;font-family:system-ui,Roboto,Arial;background:#0f172a;color:#e5e7eb}header{position:sticky;top:0;background:#111827;padding:14px 16px;font-weight:700;letter-spacing:.3px}main{padding:18px}.card{background:#0b1220;border:1px solid #1f2937;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.25)}button{padding:10px 14px;border-radius:12px;border:1px solid #1f2937;background:#1d4ed8;color:white}</style></head><body><header>ðŸ“± My Android HTML App</header><main><p>Live edit this app with HTML/CSS/JS. The phone on the right updates instantly.</p><div class="card"><h3>Hello, Jonah! ðŸ‘‹</h3><p>This is your 6.9" preview simulator.</p><button onclick="alert('It\\'s working!')">Tap Me</button></div></main></body></html>`;
    htmlEditor.setValue(starterHTML,-1);
    cssEditor.setValue("",-1);
    jsEditor.setValue("",-1);

    // ---- Persistence (localStorage) for code and UI state ----
    const LS = {
      html: 'ppe_html', css: 'ppe_css', js: 'ppe_js', tab: 'ppe_tab',
      scaleW: 'ppe_scaleW', scaleH: 'ppe_scaleH', radius: 'ppe_radius', rotated: 'ppe_rotated',
      device: 'ppe_device', theme: 'ppe_theme',
      sw_ms: 'ppe_sw_ms', sw_run: 'ppe_sw_run', sw_start: 'ppe_sw_start',
      split: 'ppe_split',
      swap: 'ppe_swap'
    };
    function safeGet(key){ try{ return localStorage.getItem(key); }catch{ return null; } }
    function safeSet(key,val){ try{ localStorage.setItem(key, val); }catch{ /* quota or privacy */ } }

    // Load only editor contents now (UI controls defined later)
    const savedHTML = safeGet(LS.html); if(savedHTML!==null) htmlEditor.setValue(savedHTML, -1);
    const savedCSS  = safeGet(LS.css);  if(savedCSS!==null)  cssEditor.setValue(savedCSS, -1);
    const savedJS   = safeGet(LS.js);   if(savedJS!==null)   jsEditor.setValue(savedJS, -1);

    document.querySelectorAll('.tab').forEach(t=>{t.onclick=()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      ['html','css','js'].forEach(k=>{
        const el = document.getElementById(`editor-${k}`);
        el.classList.toggle('active', k===t.dataset.target);
      });
      setTimeout(()=>{htmlEditor.resize(); cssEditor.resize(); jsEditor.resize();},0);
      safeSet(LS.tab, t.dataset.target);
      // Rebuild problems for newly active language
      renderProblems(t.dataset.target);
    }});
    // Create error badges on tabs and wire up live error counting
    const tabsByLang = {
      html: document.querySelector('.tabs .tab[data-target="html"]'),
      css:  document.querySelector('.tabs .tab[data-target="css"]'),
      js:   document.querySelector('.tabs .tab[data-target="js"]')
    };
    const editorsByLang = { html: htmlEditor, css: cssEditor, js: jsEditor };
    const badges = {};
    Object.keys(tabsByLang).forEach(lang=>{
      const b = document.createElement('span');
      b.className = 'badge';
      b.textContent = '0';
      tabsByLang[lang]?.appendChild(b);
      badges[lang] = b;
    });
    function updateBadge(lang){
      const ed = editorsByLang[lang];
      if(!ed) return;
      const anns = ed.session.getAnnotations() || [];
      const errors = anns.filter(a=>a.type==='error');
      const count = errors.length;
      const tab = tabsByLang[lang];
      const badge = badges[lang];
      if(!tab || !badge) return;
      badge.textContent = String(count);
      tab.classList.toggle('error', count>0);
      tab.title = count>0 ? `${count} error${count>1?'s':''} in ${lang.toUpperCase()}` : '';
    }
    function onAnnChange(lang){
      updateBadge(lang);
      // If this lang is active in UI, keep the Problems panel in sync
      const t = document.querySelector('.tabs .tab.active');
      if(t && t.dataset.target===lang) renderProblems(lang);
      // Always update badge on the Problems button
      updateProblemsCount(lang);
    }
    // Listen for Ace annotation changes per editor
    htmlEditor.session.on('changeAnnotation', ()=> onAnnChange('html'));
    cssEditor.session.on('changeAnnotation',  ()=> onAnnChange('css'));
    jsEditor.session.on('changeAnnotation',   ()=> onAnnChange('js'));
    // Initial update after editors are ready
    setTimeout(()=>{ ['html','css','js'].forEach(l=>{ updateBadge(l); }); renderProblems(activeLang()); }, 0);

    // --- Problems panel (VS Code-like) ---
    const problemsBtn = document.getElementById('problems');
    const problemsPanel = document.getElementById('problemsPanel');
    const problemsCountEl = document.getElementById('problemsCount');
    function editorFor(lang){ return lang==='css'?cssEditor : lang==='js'?jsEditor : htmlEditor; }
    function collectProblems(lang){
      const ed = editorFor(lang);
      if(!ed) return [];
      const anns = ed.session.getAnnotations() || [];
      // only errors for count emphasis; include warnings in list as well
      return anns.map(a=>({
        type: a.type || 'info',
        text: String(a.text||''),
        row: Number.isInteger(a.row)? a.row : 0,
        column: Number.isInteger(a.column)? a.column : 0
      }));
    }
    function updateProblemsCount(lang){
      // show count of errors for the active lang
      const list = collectProblems(lang).filter(p=>p.type==='error');
      const n = list.length;
      if(problemsCountEl){
        problemsCountEl.textContent = String(n);
        problemsCountEl.style.display = n>0 ? 'inline-block' : 'none';
      }
    }
    function iconFor(type){ return type==='warning' ? 'ti-alert-circle' : (type==='error' ? 'ti-alert-triangle' : 'ti-info-circle'); }
    function colorFor(type){ return type==='warning' ? '#f59e0b' : (type==='error' ? '#ef4444' : '#60a5fa'); }
    function renderProblems(lang){
      if(!problemsPanel) return;
      const items = collectProblems(lang);
      updateProblemsCount(lang);
      if(items.length===0){ problemsPanel.innerHTML = '<div class="item" style="opacity:.7"><span class="ic"><i class="ti ti-circle-check" style="color:#34d399"></i></span><div class="msg">No problems</div></div>'; return; }
      problemsPanel.innerHTML = items.map((p,i)=>{
        const line = (p.row+1);
        const col = (p.column+1);
        return `<div class="item" data-idx="${i}" data-row="${p.row}" data-col="${p.column}" data-type="${p.type}">
          <span class="ic"><i class="ti ${iconFor(p.type)}" style="color:${colorFor(p.type)}"></i></span>
          <div class="msg">${p.text || '(unknown)'}<div class="loc">${lang.toUpperCase()} â€¢ ${line}:${col}</div></div>
        </div>`;
      }).join('');
    }
    // Toggle panel
    problemsBtn?.addEventListener('click', ()=>{
      const lang = activeLang();
      renderProblems(lang);
      const visible = problemsPanel.style.display !== 'none';
      problemsPanel.style.display = visible ? 'none' : 'block';
    });
    // Navigate on click
    problemsPanel?.addEventListener('click', (e)=>{
      const item = e.target.closest('.item');
      if(!item) return;
      const lang = activeLang();
      const row = parseInt(item.dataset.row||'0',10)||0;
      const col = parseInt(item.dataset.col||'0',10)||0;
      const ed = editorFor(lang);
      if(!ed) return;
      ed.focus();
      ed.gotoLine(row+1, col, true);
      // ensure caret is visible
      ed.centerSelection();
    });

    // (Hover tooltip removed by request)
    // restore last active tab
    const savedTab = safeGet(LS.tab) || 'html';
    const tabBtn = document.querySelector(`.tabs .tab[data-target="${savedTab}"]`);
    if(tabBtn) tabBtn.click();

    const iframe = document.getElementById('preview');
    const auto = document.getElementById('auto');
    const build = ()=>{
      let html=htmlEditor.getValue(),css=cssEditor.getValue(),js=jsEditor.getValue();
      const hasHead=/<head[\s>]/i.test(html);
      let final;
      const endScript = '</' + 'script>';
      if(hasHead){
        final = html.replace(/<\/head>/i, '<style>' + css + '</style></head>');
      } else {
        final = '<!doctype html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/>' +
                '<style>' + css + '</style></head><body>' + html + '</body></html>';
      }
      // force no horizontal scroll inside iframe page
      const antiHScroll = '<style>html,body{overflow-x:hidden!important;overflow-y:auto!important}</style>';
      const selectionCSS = '<style>::selection{background:rgba(66,133,244,.35)}::-moz-selection{background:rgba(66,133,244,.35)}</style>';
      if (/<head[\s>]/i.test(final)) {
        final = final.replace(/<\/head>/i, antiHScroll + selectionCSS + '</head>');
      } else {
        final = final.replace(/<body[^>]*>/i, '$&' + antiHScroll + selectionCSS);
      }
      // inject JS; avoid writing the literal closing script tag token
      final = final.replace(/<\/body>/i, '<script>' + js + endScript + '</body>');
      iframe.srcdoc = final;
    };
    // Save editors + live build
    htmlEditor.on('change',()=>{ safeSet(LS.html, htmlEditor.getValue()); if(auto.checked) setTimeout(build,200); });
    cssEditor.on('change', ()=>{ safeSet(LS.css,  cssEditor.getValue());  if(auto.checked) setTimeout(build,200); });
    jsEditor.on('change',  ()=>{ safeSet(LS.js,   jsEditor.getValue());   if(auto.checked) setTimeout(build,200); });
    // helper to assemble full HTML string (same as preview)
    function combinedHTML(){
      let html=htmlEditor.getValue(),css=cssEditor.getValue(),js=jsEditor.getValue();
      const hasHead=/<head[\s>]/i.test(html);
      const endScript='</'+'script>';
      if(hasHead){
        html = html.replace(/<\/head>/i, '<style>'+css+'</style></head>');
      } else {
        html = '<!doctype html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/>'+
               '<style>'+css+'</style></head><body>'+html+'</body></html>';
      }
      const antiHScroll = '<style>html,body{overflow-x:hidden!important;overflow-y:auto!important}</style>';
      if (/<head[\s>]/i.test(html)) html = html.replace(/<\/head>/i, antiHScroll + '</head>');
      else html = html.replace(/<body[^>]*>/i, '$&'+antiHScroll);
      html = html.replace(/<\/body>/i, '<script>'+js+endScript+'</body>');
      return html;
    }
    // Copy to clipboard (active tab only)
    const copyBtn = document.getElementById('copy');
    function activeLang(){
      const t = document.querySelector('.tabs .tab.active');
      return t ? t.dataset.target : 'html';
    }
    copyBtn.addEventListener('click', async()=>{
      try{
        const lang = activeLang();
        let text = '';
        if(lang==='html') text = htmlEditor.getValue();
        else if(lang==='css') text = cssEditor.getValue();
        else if(lang==='js') text = jsEditor.getValue();
        await navigator.clipboard.writeText(text);
        const prev = copyBtn.innerHTML;
        const label = lang==='html'?'HTML':(lang==='css'?'CSS':'JS');
        copyBtn.innerHTML = `<i class="ti ti-check"></i> Copied ${label}!`;
        setTimeout(()=>copyBtn.innerHTML = prev, 1200);
      }catch(err){
        const prev = copyBtn.innerHTML; copyBtn.innerHTML = '<i class="ti ti-alert-triangle"></i> Failed';
        setTimeout(()=>copyBtn.innerHTML = prev, 1200);
        console.error(err);
      }
    });
    build();

    // --- Compact Stopwatch ---
    const swTimeEl = document.getElementById('swTime');
    const swToggle = document.getElementById('swToggle');
    const swReset  = document.getElementById('swReset');
    let swMs = parseInt(safeGet(LS.sw_ms) || '0', 10) || 0; // accumulated milliseconds
    let swRunning = safeGet(LS.sw_run) === '1';
    let swStart = parseInt(safeGet(LS.sw_start) || '0', 10) || 0; // epoch ms when started
    let swTimer = null;
    function swFormat(ms){
      const totalSec = Math.floor(ms/1000);
      const m = Math.floor(totalSec/60);
      const s = totalSec%60;
      const mm = m<10?('0'+m):String(m);
      const ss = s<10?('0'+s):String(s);
      return mm+':'+ss;
    }
    function swRender(){ swTimeEl.textContent = swFormat(swMs + (swRunning? (Date.now()-swStart) : 0)); }
    function swTick(){ swRender(); }
    function swStartTimer(){ if(swTimer) return; swStart = Date.now(); safeSet(LS.sw_start, String(swStart)); swRunning = true; safeSet(LS.sw_run, '1'); swToggle.querySelector('i').className='ti ti-player-pause'; swTimer = setInterval(swTick, 250); swRender(); }
    function swPause(){ if(!swRunning) return; swMs = swMs + (Date.now()-swStart); safeSet(LS.sw_ms, String(swMs)); swRunning=false; safeSet(LS.sw_run,'0'); swToggle.querySelector('i').className='ti ti-player-play'; if(swTimer){ clearInterval(swTimer); swTimer=null; } swRender(); }
    function swResetAll(){ swMs=0; safeSet(LS.sw_ms,'0'); swStart=Date.now(); safeSet(LS.sw_start, String(swStart)); if(!swRunning){ swToggle.querySelector('i').className='ti ti-player-play'; } swRender(); }
    swToggle?.addEventListener('click', ()=>{ swRunning ? swPause() : swStartTimer(); });
    swReset?.addEventListener('click', ()=>{ swResetAll(); });
    // Resume if was running
    if(swRunning){ swToggle.querySelector('i').className='ti ti-player-pause'; swTimer = setInterval(swTick, 250); }
    swRender();

    // --- Theme toggle (light/dark) ---
    const themeBtn = document.getElementById('themeToggle');
    function aceApplyTheme(theme){
      const aceTheme = theme==='light' ? 'ace/theme/chrome' : 'ace/theme/one_dark';
      htmlEditor.setTheme(aceTheme);
      cssEditor.setTheme(aceTheme);
      jsEditor.setTheme(aceTheme);
    }
    function updateThemeIcon(theme){
      if(!themeBtn) return;
      const i = themeBtn.querySelector('i');
      if(!i) return;
      // icon reflects current theme
      i.className = 'ti ' + (theme==='light' ? 'ti-sun' : 'ti-moon');
      themeBtn.title = theme==='light' ? 'Light mode' : 'Dark mode';
    }
    function applyTheme(theme){
      const root = document.documentElement;
      if(theme==='light') root.setAttribute('data-theme','light');
      else root.removeAttribute('data-theme');
      aceApplyTheme(theme==='light'?'light':'dark');
      updateThemeIcon(theme==='light'?'light':'dark');
      safeSet(LS.theme, theme==='light'?'light':'dark');
    }
    // initialize theme from LS or system preference
    (function initTheme(){
      const saved = safeGet(LS.theme);
      let theme = saved;
      if(!theme){
        const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        theme = prefersLight ? 'light' : 'dark';
      }
      applyTheme(theme);
    })();
    if(themeBtn){
      themeBtn.addEventListener('click', ()=>{
        const isLight = document.documentElement.getAttribute('data-theme') === 'light';
        applyTheme(isLight ? 'dark' : 'light');
      });
    }

    // --- Resizable Splitter between left and right panels ---
    const appEl = document.querySelector('.app');
    const leftEl = document.getElementById('left');
    const rightEl = document.getElementById('right');
    const splitter = document.getElementById('splitter');
    const DIVIDER_W = 8; // matches CSS width
    const GAP_W = 12; // grid gap
    const MIN_LEFT = 420; // match previous minmax
    const MIN_RIGHT = 420;

    function applySplit(leftPx){
      // constrain to ensure right >= MIN_RIGHT
      const totalCols = appEl.clientWidth - (2 * GAP_W); // remove two column gaps
      const maxLeft = Math.max(MIN_LEFT, totalCols - DIVIDER_W - MIN_RIGHT);
      const clamped = Math.min(Math.max(leftPx, MIN_LEFT), maxLeft);
      // If swapped, keep the visual left panel (#left) as the right-most column
      if(appEl.classList.contains('swap')){
        appEl.style.gridTemplateColumns = `1fr ${DIVIDER_W}px ${clamped}px`;
      } else {
        appEl.style.gridTemplateColumns = `${clamped}px ${DIVIDER_W}px 1fr`;
      }
      return clamped;
    }
    // Restore saved split
    const savedSplit = safeGet(LS.split);
    if(savedSplit){
      const val = parseFloat(savedSplit);
      if(!Number.isNaN(val)) applySplit(val);
    }

    // --- Swap panels (left/right) ---
    const swapBtn = document.getElementById('swapPanels');
    const savedSwap = safeGet(LS.swap) === '1';
    if(savedSwap) appEl.classList.add('swap');
    // If we already restored a split, re-apply it to respect swap state
    if(savedSwap && savedSplit){
      const val = parseFloat(savedSplit);
      if(!Number.isNaN(val)) applySplit(val);
    }
    if(swapBtn){
      swapBtn.addEventListener('click', ()=>{
        // preserve current visual left width across swap
        const currentLeftWidth = leftWidthPx();
        appEl.classList.toggle('swap');
        const applied = applySplit(currentLeftWidth);
        safeSet(LS.split, String(applied));
        safeSet(LS.swap, appEl.classList.contains('swap') ? '1' : '0');
      });
    }

    let dragging = false;
    let startX = 0;
    let startLeft = 0;
    function leftWidthPx(){
      const rect = leftEl.getBoundingClientRect();
      return rect.width; // includes padding/border of left panel itself
    }
    function onMouseMove(e){
      if(!dragging) return;
      const dx = e.clientX - startX;
      const newLeft = applySplit(startLeft + dx);
      // optionally store live for smoother persistence on refresh
      safeSet(LS.split, String(newLeft));
    }
    function onMouseUp(){
      if(!dragging) return;
      dragging = false;
      appEl.classList.remove('dragging');
      window.removeEventListener('mousemove', onMouseMove);
      window.removeEventListener('mouseup', onMouseUp);
    }
    splitter.addEventListener('mousedown', (e)=>{
      dragging = true;
      startX = e.clientX;
      startLeft = leftWidthPx();
      appEl.classList.add('dragging');
      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('mouseup', onMouseUp);
      e.preventDefault();
    });
    // Double-click to reset split to equal columns
    splitter.addEventListener('dblclick', ()=>{
      appEl.style.gridTemplateColumns = '';
      safeSet(LS.split, '');
    });
    // Re-apply constraints on resize
    window.addEventListener('resize', ()=>{
      const saved = parseFloat(safeGet(LS.split)||'');
      if(!Number.isNaN(saved)) applySplit(saved);
    });

    // --- Phone transform controls (independent width/height scale + rotate) ---
    const phoneEl = document.getElementById('phone');
    const scaleW = document.getElementById('scaleW');
    const scaleH = document.getElementById('scaleH');
    // Inline radius slider removed; manage via variable + Settings dialog only
    let currentRadius = 38;
    const rotateBtn = document.getElementById('rotate');
    let currentDevice = 'phone';
    let rotated = false;

    // restore UI states
    const sw = safeGet(LS.scaleW); if(sw!==null) scaleW.value = sw;
    const sh = safeGet(LS.scaleH); if(sh!==null) scaleH.value = sh;
    const rr = safeGet(LS.radius); if(rr!==null) currentRadius = parseFloat(rr);
    const rotS = safeGet(LS.rotated); if(rotS!==null) rotated = rotS==='1';
    const savedDev = safeGet(LS.device) || 'phone';
    currentDevice = savedDev;

    // inner screen element used for counter-scaling and radius
    const innerScreen = phoneEl.querySelector('.screen');

    function applyTransform(){
      const sx = parseFloat(scaleW.value);
      const sy = parseFloat(scaleH.value);
      const rot = rotated ? 'rotate(90deg) ' : '';
      // Scale the device frame
      phoneEl.style.transform = rot + `scale(${sx}, ${sy})`;
      // Counter-scale the inner screen so its content (text) stays the same size
      // Expand the screen area so after counter-scale it still fills the bezel
      innerScreen.style.transformOrigin = 'top left';
      innerScreen.style.width = (sx * 100) + '%';
      innerScreen.style.height = (sy * 100) + '%';
      innerScreen.style.transform = `scale(${1/sx}, ${1/sy})`;
    }
    scaleW.addEventListener('input', ()=>{ safeSet(LS.scaleW, scaleW.value); applyTransform(); });
    scaleH.addEventListener('input', ()=>{ safeSet(LS.scaleH, scaleH.value); applyTransform(); });
    rotateBtn.addEventListener('click', ()=>{ rotated = !rotated; safeSet(LS.rotated, rotated?'1':'0'); applyTransform(); });
    // initial transform
    applyTransform();

    // --- Corner radius control for phone + inner screen ---
    function applyRadius(){
      const r = Number.isFinite(currentRadius) ? currentRadius : 38;
      phoneEl.style.borderRadius = r + 'px';
      // inner screen sits inside a 12px bezel; keep visual gap similar
      innerScreen.style.borderRadius = Math.max(0, r - 12) + 'px';
    }
    applyRadius();

    // --- Settings dialog for radius and device ---
    const settingsBtn = document.getElementById('settings');
    const modal = document.getElementById('settingsModal');
    const dlgClose = document.getElementById('dlgClose');
    const dlgCancel = document.getElementById('dlgCancel');
    const dlgSave = document.getElementById('dlgSave');
    const dlgRadius = document.getElementById('dlgRadius');
    const dlgRadiusNum = document.getElementById('dlgRadiusNum');
    const dlgDevice = document.getElementById('dlgDevice');
    let prevRadius = String(Number.isFinite(currentRadius) ? currentRadius : 38);
    let prevDevice = currentDevice;

    function openSettings(){
      prevRadius = String(Number.isFinite(currentRadius) ? currentRadius : 38);
      prevDevice = currentDevice;
      dlgRadius.value = prevRadius;
      dlgRadiusNum.value = prevRadius;
      dlgDevice.value = currentDevice;
      modal.classList.add('open');
      // focus for accessibility
      setTimeout(()=>dlgRadius.focus(), 0);
    }
    function closeSettings(){ modal.classList.remove('open'); }
    function syncRadius(val){
      const r = Math.max(0, Math.min(80, Number(val)||0));
      dlgRadius.value = String(r);
      dlgRadiusNum.value = String(r);
      // live preview without persistence yet
      currentRadius = r;
      applyRadius();
    }
    dlgRadius.addEventListener('input', ()=> syncRadius(dlgRadius.value));
    dlgRadiusNum.addEventListener('input', ()=> syncRadius(dlgRadiusNum.value));
    // live device preview inside dialog (no persistence until Save)
    function syncDevice(dev){
      currentDevice = dev === 'tablet' ? 'tablet' : 'phone';
      applyDevice(currentDevice);
    }
    dlgDevice.addEventListener('change', ()=> syncDevice(dlgDevice.value));
    if(settingsBtn) settingsBtn.addEventListener('click', openSettings);
    dlgClose.addEventListener('click', closeSettings);
    dlgCancel.addEventListener('click', ()=>{
      // revert both radius and device
      currentRadius = parseFloat(prevRadius);
      applyRadius();
      currentDevice = prevDevice;
      applyDevice(currentDevice);
      closeSettings();
    });
    dlgSave.addEventListener('click', ()=>{
      safeSet(LS.radius, String(currentRadius));
      safeSet(LS.device, currentDevice);
      closeSettings();
    });
    // close on backdrop click
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeSettings(); });
    // ESC to close
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('open')) closeSettings(); });

    // --- Device selector (phone/tablet) ---
    function applyDevice(dev){
      // classes
      phoneEl.classList.remove('device-phone','device-tablet');
      phoneEl.classList.add(dev==='tablet'?'device-tablet':'device-phone');
      // default radii per device (can be adjusted after)
      const defaultR = dev==='tablet' ? 20 : 38;
      // set device-appropriate default radius (no persistence here)
      currentRadius = defaultR;
      applyRadius();
    }

    // Remove legacy inline radius control if present in DOM
    const legacyRadiusEl = document.getElementById('radius');
    if(legacyRadiusEl){
      const prev = legacyRadiusEl.previousElementSibling;
      if(prev && prev.tagName === 'LABEL') prev.remove();
      legacyRadiusEl.remove();
    }
    // Remove legacy inline device selector if present
    const legacyDeviceSel = document.getElementById('device');
    if(legacyDeviceSel){ legacyDeviceSel.remove(); }
    // init device from LS into state and apply (no persistence)
    applyDevice(currentDevice);

    document.getElementById('download').onclick=async()=>{
      const zip=new JSZip();
      let html=htmlEditor.getValue(),css=cssEditor.getValue(),js=jsEditor.getValue();
      const hasHead=/<head[\s>]/i.test(html);
      const endScript = '</' + 'script>';
      const antiHScroll = '<style>html,body{overflow-x:hidden!important;overflow-y:auto!important}</style>';
      if(hasHead){
        html = html.replace(/<\/head>/i, '<style>' + css + '</style>' + antiHScroll + '</head>')
                   .replace(/<\/body>/i, '<script>' + js + endScript + '</body>');
      } else {
        html = '<!doctype html><html><head><meta name="viewport" content="width=device-width, initial-scale=1"/>' +
               '<style>' + css + '</style>' + antiHScroll + '</head><body>' + html + '<script>' + js + endScript + '</body></html>';
      }
      zip.file("index.html",html);
      saveAs(await zip.generateAsync({type:"blob"}),"android-html-app.zip");
    };
  </script>
</body>
</html>
